<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Life</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #F3E9E9 0%, #E8D5E8 100%);
            min-height: 100vh;
        }
        
        .font-handwriting {
            font-family: 'Kalam', cursive;
        }
        

        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        

        .stat-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        

        .admin-table {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .table-header {
            background: rgba(169, 78, 189, 0.1);
            border-bottom: 2px solid rgba(169, 78, 189, 0.2);
        }
        
        .table-row {
            border-bottom: 1px solid rgba(169, 78, 189, 0.1);
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: rgba(169, 78, 189, 0.05);
        }
        

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #A94EBD;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(76, 175, 80, 0.2);
            color: #2E7D32;
        }
        
        .status-inactive {
            background: rgba(255, 152, 0, 0.2);
            color: #F57C00;
        }
        

        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        

        .search-box {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(169, 78, 189, 0.2);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            border-color: #A94EBD;
            box-shadow: 0 0 0 3px rgba(169, 78, 189, 0.1);
        }
        

        .mobile-menu-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: #4B2E5E;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .mobile-menu-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .mobile-menu.active {
            opacity: 1;
            visibility: visible;
        }

        .mobile-menu-content {
            position: absolute;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: linear-gradient(135deg, #F3E9E9 0%, #E8D5E8 100%);
            padding: 24px;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .mobile-menu.active .mobile-menu-content {
            right: 0;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(75, 46, 94, 0.2);
        }

        .mobile-menu-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4B2E5E;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .mobile-menu-close:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .mobile-nav-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mobile-nav-link {
            padding: 16px;
            border-radius: 12px;
            color: #4B2E5E;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            text-decoration: none;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .mobile-nav-link i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .mobile-nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            color: #A94EBD;
            transform: translateX(4px);
        }

        .mobile-nav-link.active {
            background: rgba(255, 255, 255, 0.4);
            color: #A94EBD;
        }
        

        @media (max-width: 768px) {
            .admin-table {
                font-size: 14px;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
        }
    </style>
</head>
<body>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBi4feeVAPUJJXe9qUV7j-SutsGFRnZBjo",
  authDomain: "lifeappcy.firebaseapp.com",
  projectId: "lifeappcy",
  storageBucket: "lifeappcy.firebasestorage.app",
  messagingSenderId: "598700486958",
  appId: "1:598700486958:web:307187bca0966041e84abf",
  measurementId: "G-57C80GJLZD"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>


    <header class="glass mx-4 mt-4 rounded-2xl px-6 py-4 shadow-lg">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-3">
                <div class="-to-r from-[#A94EBD] to-[#4B2E5E] rounded-xl flex items-center justify-center p-2">
                    <img src="imeges/Life Logo.png" alt="Life Logo" class="w-14 h-12 object-contain">
                </div>
                <div>
                    <span class="font-bold text-[#4B2E5E] text-2xl">Life Admin</span>
                    <p class="text-xs text-[#4B2E5E] opacity-70">User Management Dashboard</p>
                </div>
            </div>
            

            <nav class="hidden md:flex space-x-6 text-xs text-[#7a5a5a] font-semibold tracking-wide">
                <a class="hover:text-[#a87f7f] transition-colors active" href="#dashboard">DASHBOARD</a>
                <a class="hover:text-[#a87f7f] transition-colors" href="#users">USERS</a>
                <a class="hover:text-[#a87f7f] transition-colors" href="#analytics">ANALYTICS</a>
                <a class="hover:text-[#a87f7f] transition-colors" href="#settings">SETTINGS</a>
            </nav>
            

            <div class="hidden md:flex items-center space-x-3" id="admin-profile">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-user-shield text-[#4B2E5E] text-xl"></i>
                    <span id="admin-name" class="text-sm font-semibold text-[#4B2E5E]">Admin</span>
                </div>
                <button id="admin-logout-btn" class="bg-red-500 text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">LOGOUT</button>
            </div>
            

            <button id="mobile-menu-button" class="mobile-menu-button md:hidden">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </header>


    <div id="mobile-menu" class="mobile-menu">
        <div class="mobile-menu-content glass">
            <div class="mobile-menu-header">
                <h3 class="text-xl font-bold text-[#4B2E5E]">Admin Menu</h3>
                <button id="mobile-menu-close" class="mobile-menu-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mobile-nav-links">
                <a href="#dashboard" class="mobile-nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    DASHBOARD
                </a>
                <a href="#users" class="mobile-nav-link">
                    <i class="fas fa-users"></i>
                    USERS
                </a>
                <a href="#analytics" class="mobile-nav-link">
                    <i class="fas fa-chart-bar"></i>
                    ANALYTICS
                </a>
                <a href="#settings" class="mobile-nav-link">
                    <i class="fas fa-cog"></i>
                    SETTINGS
                </a>
                <button id="mobile-admin-logout" class="mobile-nav-link text-red-600">
                    <i class="fas fa-sign-out-alt"></i>
                    LOGOUT
                </button>
            </div>
        </div>
    </div>


    <main class="max-w-7xl mx-auto px-4 py-8">

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

            <div class="stat-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-[#4B2E5E] opacity-70">Total Users</p>
                        <p class="text-3xl font-bold text-[#4B2E5E]" id="total-users">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-[#A94EBD] to-[#4B2E5E] rounded-full p-3">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="text-green-600 text-sm font-semibold" id="total-users-change">+0%</span>
                    <span class="text-xs text-[#4B2E5E] opacity-70 ml-2">from last month</span>
                </div>
            </div>


            <div class="stat-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-[#4B2E5E] opacity-70">New Users Today</p>
                        <p class="text-3xl font-bold text-[#4B2E5E]" id="new-users-today">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-full p-3">
                        <i class="fas fa-user-plus text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="text-green-600 text-sm font-semibold" id="new-users-change">+0</span>
                    <span class="text-xs text-[#4B2E5E] opacity-70 ml-2">since yesterday</span>
                </div>
            </div>


            <div class="stat-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-[#4B2E5E] opacity-70">Active Users</p>
                        <p class="text-3xl font-bold text-[#4B2E5E]" id="active-users">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-full p-3">
                        <i class="fas fa-user-check text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="text-blue-600 text-sm font-semibold" id="active-users-percentage">0%</span>
                    <span class="text-xs text-[#4B2E5E] opacity-70 ml-2">of total users</span>
                </div>
            </div>


            <div class="stat-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-[#4B2E5E] opacity-70">Complete Profiles</p>
                        <p class="text-3xl font-bold text-[#4B2E5E]" id="complete-profiles">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-full p-3">
                        <i class="fas fa-user-edit text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="text-orange-600 text-sm font-semibold" id="complete-profiles-percentage">0%</span>
                    <span class="text-xs text-[#4B2E5E] opacity-70 ml-2">completion rate</span>
                </div>
            </div>
        </section>


        <section class="glass rounded-2xl p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <h2 class="text-xl font-bold text-[#4B2E5E]">User Management</h2>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <div class="relative">
                        <input type="text" id="search-users" placeholder="Search users..." class="search-box rounded-lg px-4 py-2 pl-10 w-full sm:w-64 outline-none">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-[#4B2E5E] opacity-50"></i>
                    </div>
                    <select id="filter-status" class="search-box rounded-lg px-4 py-2 outline-none">
                        <option value="">All Users</option>
                        <option value="active">Active Users</option>
                        <option value="inactive">Inactive Users</option>
                        <option value="complete">Complete Profiles</option>
                        <option value="incomplete">Incomplete Profiles</option>
                    </select>
                    <button id="refresh-data" class="bg-gradient-to-r from-[#A94EBD] to-[#4B2E5E] text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </section>


        <section class="admin-table rounded-2xl overflow-hidden mb-8">
            <div class="table-responsive">
                <table class="w-full">
                    <thead class="table-header">
                        <tr>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E]">User</th>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E] hidden md:table-cell">Email</th>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E] hidden lg:table-cell">Created</th>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E] hidden lg:table-cell">Last Login</th>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E]">Status</th>
                            <th class="text-left p-4 font-semibold text-[#4B2E5E]">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
     
                    </tbody>
                </table>
            </div>
            
    
            <div id="loading-state" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-[#4B2E5E] font-semibold">Loading users...</p>
            </div>
            

            <div id="empty-state" class="text-center py-12 hidden">
                <i class="fas fa-users text-6xl text-[#4B2E5E] opacity-30 mb-4"></i>
                <p class="text-[#4B2E5E] font-semibold">No users found</p>
            </div>
        </section>


        <section class="flex justify-center items-center space-x-4" id="pagination-section">
            <button id="prev-page" class="glass px-4 py-2 rounded-lg text-[#4B2E5E] hover:bg-[#A94EBD] hover:text-white transition-all disabled:opacity-50" disabled>
                <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            <span id="page-info" class="text-[#4B2E5E] font-semibold">Page 1 of 1</span>
            <button id="next-page" class="glass px-4 py-2 rounded-lg text-[#4B2E5E] hover:bg-[#A94EBD] hover:text-white transition-all disabled:opacity-50" disabled>
                Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
        </section>
    </main>

 
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal opacity-0 invisible p-4">
        <div class="glass rounded-2xl p-6 md:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl md:text-2xl font-semibold text-[#4B2E5E]">User Details</h3>
                <button id="close-user-modal" class="text-[#4B2E5E] hover:text-[#A94EBD] text-2xl transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="user-detail-content">
                
            </div>
        </div>
    </div>

   
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50">
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const auth = firebase.auth();
            const db = firebase.firestore();
            

            let users = [];
            let filteredUsers = [];
            let currentPage = 1;
            const usersPerPage = 10;
            let currentUser = null;
            

            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuClose = document.getElementById('mobile-menu-close');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const mobileAdminLogout = document.getElementById('mobile-admin-logout');
            const searchUsers = document.getElementById('search-users');
            const filterStatus = document.getElementById('filter-status');
            const refreshData = document.getElementById('refresh-data');
            const usersTableBody = document.getElementById('users-table-body');
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');
            const userModal = document.getElementById('user-modal');
            const closeUserModal = document.getElementById('close-user-modal');
            const userDetailContent = document.getElementById('user-detail-content');
            const toastContainer = document.getElementById('toast-container');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const pageInfo = document.getElementById('page-info');
            

            const totalUsersEl = document.getElementById('total-users');
            const newUsersTodayEl = document.getElementById('new-users-today');
            const activeUsersEl = document.getElementById('active-users');
            const completeProfilesEl = document.getElementById('complete-profiles');
            

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            mobileMenuClose.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            mobileMenu.addEventListener('click', (e) => {
                if (e.target === mobileMenu) {
                    mobileMenu.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            

            adminLogoutBtn.addEventListener('click', () => {
                auth.signOut();
            });
            
            mobileAdminLogout.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
                auth.signOut();
            });
            

            searchUsers.addEventListener('input', filterUsers);
            filterStatus.addEventListener('change', filterUsers);
            refreshData.addEventListener('click', loadUsers);
            

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderUsers();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderUsers();
                }
            });
            

            closeUserModal.addEventListener('click', closeModal);
            userModal.addEventListener('click', (e) => {
                if (e.target === userModal) {
                    closeModal();
                }
            });
            

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('admin-name').textContent = user.displayName || user.email.split('@')[0];
                    
    
                    checkAdminAccess().then(hasAccess => {
                        if (hasAccess) {
                            loadUsers();
                        } else {
                            showToast('Admin access required. Please contact administrator.', 'error');
                            showAdminAccessError();
                        }
                    });
                } else {
        
                    window.location.href = 'login.html';
                }
            });
            

            async function loadUsers() {
                showLoading(true);
                try {

                    if (!currentUser) {
                        throw new Error('User not authenticated');
                    }
                    

                    const snapshot = await db.collection('users').get();
                    users = [];
                    
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        users.push({
                            id: doc.id,
                            uid: userData.uid || doc.id,
                            name: userData.name || 'Unknown',
                            email: userData.email || 'No email',
                            createdAt: userData.createdAt,
                            lastLogin: userData.lastLogin,
                            profileComplete: userData.profileComplete || false,
                            ...userData
                        });
                    });
                    
            
                    users.sort((a, b) => {
                        const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                        const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                        return bTime - aTime;
                    });
                    
                    filteredUsers = [...users];
                    currentPage = 1;
                    updateStats();
                    renderUsers();
                    showToast('Users loaded successfully', 'success');
                } catch (error) {
                    console.error('Error loading users:', error);
                    
                    if (error.code === 'permission-denied') {
                        showToast('Access denied. Please check Firestore security rules.', 'error');
                        showPermissionError();
                    } else if (error.message.includes('Missing or insufficient permissions')) {
                        showToast('Insufficient permissions. Please update Firestore rules.', 'error');
                        showPermissionError();
                    } else {
                        showToast('Error loading users: ' + error.message, 'error');
                    }
                } finally {
                    showLoading(false);
                }
            }
            
        
            function filterUsers() {
                const searchTerm = searchUsers.value.toLowerCase();
                const statusFilter = filterStatus.value;
                
                filteredUsers = users.filter(user => {
                    const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                        user.email.toLowerCase().includes(searchTerm);
                    
                    let matchesStatus = true;
                    if (statusFilter === 'active') {
                        matchesStatus = isUserActive(user);
                    } else if (statusFilter === 'inactive') {
                        matchesStatus = !isUserActive(user);
                    } else if (statusFilter === 'complete') {
                        matchesStatus = user.profileComplete;
                    } else if (statusFilter === 'incomplete') {
                        matchesStatus = !user.profileComplete;
                    }
                    
                    return matchesSearch && matchesStatus;
                });
                
                currentPage = 1;
                renderUsers();
            }
            
        
            function isUserActive(user) {
                if (!user.lastLogin) return false;
                const lastLogin = user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return lastLogin > thirtyDaysAgo;
            }
            
    
            function updateStats() {
                const totalUsers = users.length;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const newUsersToday = users.filter(user => {
                    if (!user.createdAt) return false;
                    const createdDate = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
                    return createdDate >= today;
                }).length;
                
                const activeUsers = users.filter(isUserActive).length;
                const completeProfiles = users.filter(user => user.profileComplete).length;
                
                totalUsersEl.textContent = totalUsers;
                newUsersTodayEl.textContent = newUsersToday;
                activeUsersEl.textContent = activeUsers;
                completeProfilesEl.textContent = completeProfiles;
                
            
                document.getElementById('active-users-percentage').textContent = 
                    totalUsers > 0 ? Math.round((activeUsers / totalUsers) * 100) + '%' : '0%';
                document.getElementById('complete-profiles-percentage').textContent = 
                    totalUsers > 0 ? Math.round((completeProfiles / totalUsers) * 100) + '%' : '0%';
            }
            
   
            function renderUsers() {
                const startIndex = (currentPage - 1) * usersPerPage;
                const endIndex = startIndex + usersPerPage;
                const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
                
                if (paginatedUsers.length === 0) {
                    usersTableBody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    document.querySelector('.table-responsive').classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    document.querySelector('.table-responsive').classList.remove('hidden');
                    
                    usersTableBody.innerHTML = paginatedUsers.map(user => {
                        const isActive = isUserActive(user);
                        const createdDate = user.createdAt ? 
                            (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt)).toLocaleDateString() : 
                            'Unknown';
                        const lastLoginDate = user.lastLogin ? 
                            (user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin)).toLocaleDateString() : 
                            'Never';
                        
                        return `
                            <tr class="table-row">
                                <td class="p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="bg-gradient-to-br from-[#A94EBD] to-[#4B2E5E] rounded-full w-10 h-10 flex items-center justify-center">
                                            <span class="text-white font-semibold">${user.name.charAt(0).toUpperCase()}</span>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-[#4B2E5E]">${user.name}</p>
                                            <p class="text-xs text-[#4B2E5E] opacity-70 md:hidden">${user.email}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-4 hidden md:table-cell">
                                    <p class="text-sm text-[#4B2E5E]">${user.email}</p>
                                </td>
                                <td class="p-4 hidden lg:table-cell">
                                    <p class="text-sm text-[#4B2E5E]">${createdDate}</p>
                                </td>
                                <td class="p-4 hidden lg:table-cell">
                                    <p class="text-sm text-[#4B2E5E]">${lastLoginDate}</p>
                                </td>
                                <td class="p-4">
                                    <div class="flex flex-col space-y-1">
                                        <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                            ${isActive ? 'Active' : 'Inactive'}
                                        </span>
                                        <span class="status-badge ${user.profileComplete ? 'status-active' : 'status-inactive'}">
                                            ${user.profileComplete ? 'Complete' : 'Incomplete'}
                                        </span>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <button onclick="viewUserDetails('${user.id}')" class="bg-[#A94EBD] text-white px-3 py-1 rounded-lg text-sm hover:bg-[#4B2E5E] transition-colors">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                updatePagination();
            }
            

            function updatePagination() {
                const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            }
            

            window.viewUserDetails = function(userId) {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const createdDate = user.createdAt ? 
                    (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt)).toLocaleString() : 
                    'Unknown';
                const lastLoginDate = user.lastLogin ? 
                    (user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin)).toLocaleString() : 
                    'Never logged in';
                
                userDetailContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-br from-[#A94EBD] to-[#4B2E5E] rounded-full w-16 h-16 flex items-center justify-center">
                                <span class="text-white font-bold text-2xl">${user.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold text-[#4B2E5E]">${user.name}</h4>
                                <p class="text-[#4B2E5E] opacity-70">${user.email}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="glass rounded-lg p-4">
                                <h5 class="font-semibold text-[#4B2E5E] mb-2">Account Information</h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-[#4B2E5E] opacity-70">User ID:</span>
                                        <span class="text-[#4B2E5E] font-mono">${user.uid}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-[#4B2E5E] opacity-70">Created:</span>
                                        <span class="text-[#4B2E5E]">${createdDate}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-[#4B2E5E] opacity-70">Last Login:</span>
                                        <span class="text-[#4B2E5E]">${lastLoginDate}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="glass rounded-lg p-4">
                                <h5 class="font-semibold text-[#4B2E5E] mb-2">Profile Status</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-[#4B2E5E] opacity-70">Profile Complete:</span>
                                        <span class="status-badge ${user.profileComplete ? 'status-active' : 'status-inactive'}">
                                            ${user.profileComplete ? 'Yes' : 'No'}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-[#4B2E5E] opacity-70">Account Status:</span>
                                        <span class="status-badge ${isUserActive(user) ? 'status-active' : 'status-inactive'}">
                                            ${isUserActive(user) ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-lg p-4">
                            <h5 class="font-semibold text-[#4B2E5E] mb-2">Additional Data</h5>
                            <pre class="text-xs text-[#4B2E5E] bg-white bg-opacity-50 rounded p-3 overflow-auto max-h-40">${JSON.stringify(user, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                userModal.classList.remove('invisible', 'opacity-0');
                userModal.classList.add('opacity-100');
            };
            

            function closeModal() {
                userModal.classList.remove('opacity-100');
                userModal.classList.add('opacity-0', 'invisible');
            }
            

            function showLoading(show) {
                if (show) {
                    loadingState.classList.remove('hidden');
                    document.querySelector('.table-responsive').classList.add('hidden');
                    emptyState.classList.add('hidden');
                } else {
                    loadingState.classList.add('hidden');
                }
            }
            

            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `glass rounded-xl p-4 mb-2 text-sm font-semibold transition-all transform translate-x-full opacity-0 shadow-lg ${
                    type === 'success' ? 'text-green-600 border-l-4 border-green-500' : 
                    type === 'error' ? 'text-red-600 border-l-4 border-red-500' : 
                    'text-[#4B2E5E] border-l-4 border-[#A94EBD]'
                }`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    info: 'fas fa-info-circle'
                };
                
                toast.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="${icons[type] || icons.info}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            }
            

            function showPermissionError() {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-8 text-center">
                            <div class="glass rounded-2xl p-6 max-w-2xl mx-auto">
                                <i class="fas fa-shield-alt text-6xl text-red-500 mb-4"></i>
                                <h3 class="text-xl font-bold text-[#4B2E5E] mb-4">Firestore Permission Error</h3>
                                <p class="text-[#4B2E5E] mb-6">
                                    The admin dashboard cannot access the users collection due to Firestore security rules.
                                    Please update your Firestore rules to allow admin access.
                                </p>
                                
                                <div class="bg-gray-100 rounded-lg p-4 mb-4 text-left">
                                    <h4 class="font-semibold text-[#4B2E5E] mb-2">Required Firestore Rules:</h4>
                                    <pre class="text-xs text-gray-700 overflow-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow admin users to read all users (replace with your admin email)
    match /users/{document=**} {
      allow read: if request.auth != null && 
        request.auth.token.email == "your-admin-email@gmail.com";
    }
    
    // Allow users to manage their own events
    match /events/{eventId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
  }
}</code></pre>
                                </div>
                                
                                <div class="text-sm text-[#4B2E5E] space-y-2">
                                    <p><strong>Steps to fix:</strong></p>
                                    <ol class="list-decimal list-inside space-y-1 text-left">
                                        <li>Go to Firebase Console → Firestore Database → Rules</li>
                                        <li>Replace "your-admin-email@gmail.com" with your actual admin email</li>
                                        <li>Click "Publish" to update the rules</li>
                                        <li>Refresh this page</li>
                                    </ol>
                                </div>
                                
                                <button onclick="loadUsers()" class="mt-4 bg-gradient-to-r from-[#A94EBD] to-[#4B2E5E] text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all">
                                    <i class="fas fa-sync-alt mr-2"></i>Try Again
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                document.querySelector('.table-responsive').classList.remove('hidden');
                emptyState.classList.add('hidden');
            }


            async function checkAdminAccess() {
                try {

                    const testDoc = await db.collection('users').limit(1).get();
                    return true;
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        return false;
                    }
                    throw error;
                }
            }


            function showAdminAccessError() {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-8 text-center">
                            <div class="glass rounded-2xl p-6 max-w-lg mx-auto">
                                <i class="fas fa-user-shield text-6xl text-orange-500 mb-4"></i>
                                <h3 class="text-xl font-bold text-[#4B2E5E] mb-4">Admin Access Required</h3>
                                <p class="text-[#4B2E5E] mb-4">
                                    Your account (${currentUser.email}) does not have admin privileges.
                                    Please contact the system administrator to grant admin access.
                                </p>
                                <button onclick="auth.signOut()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                document.querySelector('.table-responsive').classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
            

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && userModal.classList.contains('opacity-100')) {
                    closeModal();
                }
                
                if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
                    mobileMenu.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });
    </script>
</body>
</html>
